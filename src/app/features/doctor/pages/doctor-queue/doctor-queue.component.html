<div class="queue-container p-4">
  <div class="flex justify-content-between align-items-center mb-5">
    <div>
      <h1 class="text-2xl font-bold text-900 m-0">Patient Queue</h1>
      <p class="text-500 text-sm mt-1">Manage current patient flow and consultations</p>
    </div>
    <div class="flex gap-2">
      <p-button label="Refresh" icon="pi pi-refresh" styleClass="p-button-text font-semibold"></p-button>
    </div>
  </div>

  @if (queue$ | async; as queue) {
  <div class="clinical-card shadow-2 border-round-xl overflow-hidden">
    <p-table #dt [value]="queue" [paginator]="true" [rows]="10"
      [globalFilterFields]="['tokenNumber', 'patientName', 'department', 'visitType', 'status']"
      styleClass="clinical-table" responsiveLayout="scroll">

      <ng-template pTemplate="caption">
        <div class="flex justify-content-between align-items-center">
          <h3 class="m-0 text-900 font-bold text-base">Waiting List</h3>
          <span class="p-input-icon-left">
            <i class="pi pi-search"></i>
            <input pInputText type="text" (input)="dt.filterGlobal($any($event.target).value, 'contains')"
              placeholder="Search patients..." class="w-15rem" />
          </span>
        </div>
      </ng-template>

      <ng-template pTemplate="header">
        <tr>
          <th style="width: 80px">#</th>
          <th pSortableColumn="tokenNumber" style="width: 140px">
            Token <p-sortIcon field="tokenNumber"></p-sortIcon>
          </th>
          <th pSortableColumn="patientName">Patient Name <p-sortIcon field="patientName"></p-sortIcon></th>
          <th pSortableColumn="visitType">Type <p-sortIcon field="visitType"></p-sortIcon></th>
          <th pSortableColumn="priority" style="width: 150px">Priority <p-sortIcon field="priority"></p-sortIcon></th>
          <th pSortableColumn="status" style="width: 180px">Status <p-sortIcon field="status"></p-sortIcon></th>
          <th style="width: 150px" class="text-right">Action</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-token>
        <tr [class.urgent-row]="token.priority === Priority.URGENT">
          <td><span class="text-500 font-bold">#{{ token.queuePosition }}</span></td>
          <td><span class="token-id">{{ token.tokenNumber }}</span></td>
          <td>
            <div class="flex flex-column">
              <span class="font-semibold text-900">{{ token.patientName }}</span>
              <span class="text-xs text-500">ID: {{ token.patientId.substring(0,8) }}</span>
            </div>
          </td>
          <td>
            <span class="text-700">{{ token.visitType }}</span>
          </td>
          <td>
            <p-tag [value]="getPriorityLabel(token.priority)" [severity]="getPrioritySeverity(token.priority)"></p-tag>
          </td>
          <td>
            <div class="flex align-items-center gap-2">
              <span class="w-2 h-2 border-circle" [style.background]="getStatusColor(token.status)"></span>
              <span class="text-sm text-700">{{ token.status }}</span>
            </div>
          </td>
          <td class="text-right">
            @if (token.status === TokenStatus.CHECKED_IN) {
            <p-button label="Examine" icon="pi pi-play" styleClass="p-button-success p-button-sm px-3"
              (onClick)="callNext(token)"></p-button>
            }
            @if (token.status === TokenStatus.IN_CONSULTATION) {
            <p-button label="Resume" icon="pi pi-external-link" styleClass="p-button-info p-button-sm px-3"
              [routerLink]="['/doctor/consultation', token.id]"
              [queryParams]="{ patientId: token.patientId }"></p-button>
            }
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center py-8">
            <div class="flex flex-column align-items-center gap-3">
              <i class="pi pi-inbox text-300 text-5xl"></i>
              <h3 class="text-400 font-bold m-0">No Patients in Queue</h3>
              <p class="text-500 m-0 text-sm">Waiting for new check-ins.</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
  }
</div>