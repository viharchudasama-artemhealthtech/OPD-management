<div class="billing-page p-4 bg-50 min-h-screen">
    <p-toast></p-toast>

    <div class="max-w-7xl mx-auto">
        <!-- Top Toolbar -->
        <div class="flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="m-0 text-3xl font-bold text-900">Billing System</h1>
                <p class="text-600 m-0">Generate medical invoices and vouchers</p>
            </div>
            <p-button label="View All Patients" icon="pi pi-users" severity="secondary" [text]="true"
                (onClick)="onCancel()"></p-button>
        </div>

        <div class="grid pb-6">
            <!-- Left Panel: Patient Selection -->
            <div class="col-12 lg:col-4 xl:col-3">
                <p-card styleClass="h-full border-none shadow-1 sticky-nav">
                    <div class="p-2">
                        <h3 class="mt-0 mb-3 text-lg font-semibold flex align-items-center gap-2">
                            <i class="pi pi-search text-primary"></i>
                            Select Patient
                        </h3>
                        <p-dropdown [options]="allPatients" [(ngModel)]="patientId" optionLabel="fullName"
                            optionValue="id" [filter]="true" filterBy="fullName,id,appointmentCode"
                            placeholder="Search by Name, ID or Code" (onChange)="selectPatient($any($event).value)"
                            appendTo="body" styleClass="w-full professional-dropdown">
                            <ng-template let-p pTemplate="item">
                                <div class="flex align-items-center justify-content-between w-full">
                                    <div class="flex align-items-center gap-2">
                                        <i class="pi pi-user text-primary-400"></i>
                                        <span>{{ p.fullName }}</span>
                                    </div>
                                    @if (p.hasAppointment) {
                                    <span class="badge-appointment px-2 py-1 text-xs border-round">Today</span>
                                    }
                                </div>
                            </ng-template>
                        </p-dropdown>

                        @if (patient) {
                        <div class="mt-4 pt-4 border-top-1 surface-border">
                            <div class="flex align-items-center gap-3 mb-3">
                                <p-avatar [label]="patient.fullName.charAt(0)" size="large" shape="circle"
                                    styleClass="bg-primary-100 text-primary-700 font-bold"></p-avatar>
                                <div>
                                    <div class="font-bold text-800">{{ patient.fullName }}</div>
                                    <div class="text-sm text-500">ID: {{ patient.id }}</div>
                                </div>
                            </div>
                            <div class="grid text-sm row-gap-2">
                                <div class="col-5 text-500">Phone:</div>
                                <div class="col-7 font-medium">{{ patient.phone }}</div>
                                <div class="col-5 text-500">Age/Gender:</div>
                                <div class="col-7 font-medium">{{ patient.age }} / {{ patient.gender }}</div>
                                @if (patientId?.startsWith('P')) {
                                <div class="col-12">
                                    <span
                                        class="text-xs px-2 py-1 bg-blue-50 text-blue-600 border-round font-medium">Portal
                                        User</span>
                                </div>
                                }
                            </div>
                        </div>
                        } @else {
                        <div class="text-center py-6">
                            <i class="pi pi-user-plus text-3xl text-300 mb-2"></i>
                            <p class="text-500 text-sm">Select a patient to start generating the bill</p>
                        </div>
                        }
                    </div>
                </p-card>
            </div>

            <!-- Right Panel: The Real Bill -->
            <div class="col-12 lg:col-8 xl:col-9">
                <div
                    class="invoice-container bg-white border-round-xl shadow-2 overflow-hidden border-1 surface-border">
                    <!-- Invoice Header Decorator -->
                    <div class="h-1rem bg-primary"></div>

                    <div class="p-5 md:p-8">
                        @if (!patient) {
                        <div
                            class="flex flex-column align-items-center justify-content-center py-8 text-center bg-50 border-round border-dashed border-2 surface-border">
                            <div class="border-round-circle bg-white shadow-1 p-4 mb-4">
                                <i class="pi pi-receipt text-5xl text-300"></i>
                            </div>
                            <h2 class="m-0 text-900 font-bold">New Invoice</h2>
                            <p class="text-600 mt-2 max-w-20rem mx-auto">Complete patient selection to prepare the bill
                                items and pricing details.</p>
                        </div>
                        } @else {
                        <form [formGroup]="billForm" (ngSubmit)="onSubmit()">
                            <!-- Professional Invoice Header -->
                            <div
                                class="flex flex-column md:flex-row justify-content-between mb-6 pb-6 border-bottom-1 surface-border">
                                <div>
                                    <h1 class="m-0 text-4xl font-extrabold text-primary tracking-tight">INVOICE</h1>
                                    <p class="text-500 mt-1 uppercase tracking-widest text-xs font-bold">BMC Hospital
                                    </p>
                                </div>
                                <div class="text-right mt-4 md:mt-0">
                                    <div class="text-sm font-bold text-800">Date: {{ today | date:'mediumDate' }}</div>
                                    <div class="text-xs text-500">No: INV-{{ today | date:'yyyyMMdd' }}-{{ patient.id }}
                                    </div>
                                </div>
                            </div>

                            <!-- Meta Section -->
                            <div class="grid mb-6">
                                <div class="col-12 md:col-6">
                                    <p class="text-xs font-bold text-500 uppercase mb-2">Billed To:</p>
                                    <h3 class="m-0 font-bold text-900">{{ patient.fullName }}</h3>
                                    <p class="text-sm text-600 m-0 mt-1">Patient ID: {{ patient.id }}</p>
                                    <p class="text-sm text-600 m-0">{{ patient.phone }}</p>
                                </div>
                                <div class="col-12 md:col-6 md:text-right">
                                    <p class="text-xs font-bold text-500 uppercase mb-2">Hospital Details:</p>
                                    <h3 class="m-0 font-bold text-900">BMC Hospital</h3>
                                    <p class="text-sm text-600 m-0 mt-1">123 Health Street, City Complex</p>
                                    <p class="text-sm text-600 m-0">Tel: +91 12345 67890</p>
                                </div>
                            </div>

                            <!-- Items Table -->
                            <div formArrayName="items" class="invoice-items mb-5">
                                <p-table [value]="items.controls" styleClass="p-datatable-invoice">
                                    <ng-template pTemplate="header">
                                        <tr>
                                            <th class="bg-gray-50 uppercase text-xs font-bold text-700">Service
                                                Description</th>
                                            <th class="bg-gray-50 uppercase text-xs font-bold text-700"
                                                style="width: 150px">Category</th>
                                            <th class="bg-gray-50 uppercase text-xs font-bold text-700 text-center"
                                                style="width: 80px">Qty</th>
                                            <th class="bg-gray-50 uppercase text-xs font-bold text-700 text-right"
                                                style="width: 150px">Price</th>
                                            <th class="bg-gray-50 uppercase text-xs font-bold text-700 text-right"
                                                style="width: 150px">Total</th>
                                            <th class="bg-gray-50" style="width: 50px"></th>
                                        </tr>
                                    </ng-template>
                                    <ng-template pTemplate="body" let-item let-i="rowIndex">
                                        <tr [formGroupName]="i" class="border-bottom-1 surface-border">
                                            <td class="py-3">
                                                <input pInputText formControlName="description"
                                                    placeholder="e.g., General Consultation"
                                                    class="w-full border-none p-0 focus:shadow-none font-medium text-800" />
                                            </td>
                                            <td class="py-3">
                                                <p-dropdown [options]="categoryOptions" formControlName="category"
                                                    appendTo="body"
                                                    styleClass="w-full border-none p-0 bg-transparent dropdown-flat"></p-dropdown>
                                            </td>
                                            <td class="py-3">
                                                <p-inputNumber formControlName="quantity" [min]="1"
                                                    [showButtons]="false"
                                                    inputStyleClass="w-full border-none p-0 text-center bg-transparent"></p-inputNumber>
                                            </td>
                                            <td class="py-3">
                                                <p-inputNumber formControlName="unitPrice" mode="currency"
                                                    currency="INR" [min]="0"
                                                    inputStyleClass="w-full border-none p-0 text-right bg-transparent font-medium"></p-inputNumber>
                                            </td>
                                            <td class="py-3 text-right">
                                                <span class="font-bold text-800">{{ items.at(i).get('total')?.value |
                                                    currency:'INR' }}</span>
                                            </td>
                                            <td class="py-3 text-center">
                                                <button type="button" pButton icon="pi pi-trash"
                                                    class="p-button-rounded p-button-danger p-button-text p-button-sm opacity-50 hover-opacity-100"
                                                    (click)="removeItem(i)"></button>
                                            </td>
                                        </tr>
                                    </ng-template>
                                </p-table>

                                <div class="mt-4 flex justify-content-start">
                                    <p-button label="Add Service / Item" icon="pi pi-plus" [text]="true" size="small"
                                        (onClick)="addItem()" styleClass="text-primary font-bold"></p-button>
                                </div>
                            </div>

                            <!-- Summary Grid -->
                            <div
                                class="flex flex-column md:flex-row justify-content-between pt-6 mt-4 border-top-1 surface-border">
                                <div class="max-w-20rem mb-4 md:mb-0">
                                    <h4 class="m-0 text-sm font-bold text-700 uppercase mb-2">Terms & Conditions</h4>
                                    <p class="text-xs text-500 m-0">This is a computer generated invoice and does not
                                        require a signature. Please keep it for your records.</p>
                                </div>

                                <div class="w-full md:w-20rem">
                                    <div class="flex justify-content-between mb-3">
                                        <span class="text-600 font-medium font-bold uppercase text-xs">Subtotal</span>
                                        <span class="text-800 font-bold">{{ billForm.get('subTotal')?.value |
                                            currency:'INR' }}</span>
                                    </div>
                                    <div class="flex justify-content-between mb-3 align-items-center">
                                        <span class="text-600 font-medium font-bold uppercase text-xs">Discount</span>
                                        <div class="flex align-items-center gap-2">
                                            <p-inputNumber formControlName="discountAmount" mode="currency"
                                                currency="INR"
                                                inputStyleClass="w-7rem text-right p-1 font-medium border-1 surface-border border-round"></p-inputNumber>
                                        </div>
                                    </div>
                                    <div class="flex justify-content-between mb-3 align-items-center">
                                        <span class="text-600 font-medium font-bold uppercase text-xs">Tax / GST</span>
                                        <p-inputNumber formControlName="taxAmount" mode="currency" currency="INR"
                                            inputStyleClass="w-7rem text-right p-1 font-medium border-1 surface-border border-round"></p-inputNumber>
                                    </div>

                                    <div
                                        class="bg-primary-50 p-4 border-round-lg mt-4 shadow-sm border-1 border-primary-100">
                                        <div class="flex justify-content-between align-items-center">
                                            <span
                                                class="text-primary-700 font-extrabold uppercase text-sm tracking-widest">Grand
                                                Total</span>
                                            <span class="text-2xl font-black text-primary-900">{{
                                                billForm.get('totalAmount')?.value | currency:'INR' }}</span>
                                        </div>
                                    </div>

                                    <div class="mt-6">
                                        <p-button type="submit" label="GENERATE INVOICE" icon="pi pi-file-pdf"
                                            class="w-full"
                                            [disabled]="billForm.invalid || !patient || items.length === 0"
                                            styleClass="w-full py-4 text-xl font-black shadow-2 hover:shadow-4 transition-all"></p-button>
                                    </div>
                                </div>
                            </div>
                        </form>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>